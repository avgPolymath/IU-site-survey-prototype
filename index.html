<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Infinite Uptime – SDD (Phone Prototype)</title>
  <style>
    :root{
      --iu-primary:#556CE3;
      --iu-grad-start:#4F92DE;
      --iu-grad-end:#5F48EB;
      --iu-text:#141415;
      --iu-sub:#5A5A5C;
      --iu-muted:#949597;
      --iu-bg:#EDF2FD;
      --iu-surface:#FFFFFF;
      --iu-border:#DEE1EB;
      --iu-border-strong:#CED0D9;
      --iu-focus:#AAB5EE;
      --shadow:0 6px 16px rgba(0,0,0,0.10);
      --radius:16px;
      --maxw:440px;
    }
    html,body{margin:0;padding:0;background:var(--iu-bg);color:var(--iu-text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
    .app{max-width:var(--maxw);margin:0 auto;min-height:100vh;display:flex;flex-direction:column;}
    header{position:sticky;top:0;background:var(--iu-bg);z-index:5;padding:16px 16px 8px;border-bottom:1px solid var(--iu-border);}
    h1{margin:0;font-size:18px;letter-spacing:.2px;}
    .sub{color:var(--iu-sub);font-size:13px;margin-top:4px;}
    /* stepper */
    .stepper{display:flex;gap:8px;overflow-x:auto;padding:8px 0 4px}
    .chip{flex:0 0 auto;padding:8px 10px;border-radius:999px;border:1px solid var(--iu-border);background:#fff;color:var(--iu-sub);font-size:12px;display:flex;align-items:center;gap:8px}
    .chip.active{background:linear-gradient(90deg,var(--iu-grad-start),var(--iu-grad-end));color:#fff;border-color:transparent}
    .chip.done{border-color:var(--iu-primary);color:var(--iu-primary);background:#fff}
    .chip .icon{font-weight:700}
    main{flex:1;padding:12px 16px 96px}
    .card{background:#fff;border:1px solid var(--iu-border);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:16px}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px}
    label{font-size:12px;color:var(--iu-sub)}
    input[type=text],input[type=number],select,textarea{
      -webkit-appearance:none;appearance:none;
      padding:12px;border-radius:12px;border:1px solid var(--iu-border);
      font-size:15px;background:#fff;outline:none;
    }
    textarea{min-height:80px;resize:vertical}
    input:focus,select:focus,textarea:focus{border-color:var(--iu-primary);box-shadow:0 0 0 3px var(--iu-focus)}
    .row{display:flex;gap:8px}
    .row>.field{flex:1}
    .help{color:var(--iu-muted);font-size:12px}
    .error{color:#B00020;font-size:12px}
    .req{color:#B00020;font-weight:600}
    .warn{color:#9A6700;font-size:12px}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 16px;border-radius:999px;border:1px solid var(--iu-border);background:#fff;color:var(--iu-primary);font-weight:600}
    .btn.primary{background:linear-gradient(90deg,var(--iu-grad-start),var(--iu-grad-end));color:#fff;border:none}
    .btn.ghost{border:none;color:var(--iu-primary);background:transparent}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    /* sticky footer CTA */
    .footer{
      position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--iu-border);
      padding:10px 16px;display:flex;justify-content:center;z-index:10;
    }
    .footer .inner{width:100%;max-width:var(--maxw);display:flex;gap:8px}
    .footer .grow{flex:1}
    .disabled{opacity:.55;pointer-events:none}
    /* toast */
    .toast{position:fixed;left:50%;transform:translateX(-50%);top:10px;background:#fff;border:1px solid var(--iu-border);box-shadow:var(--shadow);border-radius:12px;padding:10px 14px;font-size:13px;z-index:20}
    .list{display:flex;flex-direction:column;gap:8px}
    .issue{padding:10px;border:1px dashed var(--iu-border);border-radius:10px;background:#fff}
    .pill{padding:6px 10px;border-radius:999px;background:#EEF1FF;color:var(--iu-primary);font-size:12px;font-weight:600;display:inline-block}
    .muted{color:var(--iu-muted)}
    .header-actions{display:flex;gap:8px;margin-top:8px}
    .shadow-none{box-shadow:none;border-color:var(--iu-border)}
    .hidden{display:none !important}
    .icon-btn{width:44px;height:44px;border-radius:999px;border:1px solid var(--iu-border);background:#fff;display:inline-flex;align-items:center;justify-content:center;box-shadow:var(--shadow)}
    .icon-btn svg{width:20px;height:20px;stroke:var(--iu-primary);fill:none}
    .btn.danger{border-color:#ff3b30;color:#ff3b30}
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Infinite Uptime — SDD</h1>
    <div class="sub">Phone-first prototype • Offline-ready • Local-only</div>
    <div class="stepper" id="stepper"></div>
    <div class="header-actions">
      <button class="btn" id="btnHome">Home</button>
      <button class="btn" id="btnExport">Export JSON</button>
      <button class="btn" id="btnReset">Reset</button>
    </div>
  </header>
  <main id="main"></main>
  <div class="footer">
    <div class="inner">
      <div id="ctaInfo" class="pill hidden"></div>
      <button class="btn grow primary" id="btnNext">Save & Continue</button>
    </div>
  </div>
</div>

<div id="toast" class="toast hidden"></div>

<script>
/** UTIL **/
const $ = sel => document.querySelector(sel);
const $$ = sel => [...document.querySelectorAll(sel)];
const show = (el) => el.classList.remove('hidden');
const hide = (el) => el.classList.add('hidden');
const toast = (msg, ms=1800) => { const t=$("#toast"); t.textContent=msg; show(t); setTimeout(()=>hide(t), ms); };

const LS_KEY = "sdd_proto_state_v3";
const clone = (x)=>JSON.parse(JSON.stringify(x));

const SENSOR_RPM_BANDS = {
  "vEdge 4.2": [20,2900],
  "vEdge 4.3": [20,10000],
  "Uni-axial ICP": [5,3900],
  "Tri-axial ICP": [100,3000]
};
const COUPLING_TYPES = [
  "BARREL COUPLING",
  "BELT DRIVEN COUPLING",
  "CLAMP OR SPLIT-MUFF OR COMPRESSION COUPLING",
  "DIAPHRAGM COUPLING",
  "DIRECT (NO COUPLING)",
  "DISC COUPLING",
  "FLANGE COUPLING",
  "FLEXIBLE COUPLING",
  "FLUID COUPLING",
  "GEAR COUPLING",
  "GRID COUPLING/SPRING COUPLING/RESILIENT COUPLING",
  "JAW COUPLING",
  "MAGNETIC COUPLING",
  "MULTI BEAM COUPLING",
  "OLDHAM COUPLING",
  "PIN BUSH COUPLING",
  "PRECISION METAL BELLOW COUPLING",
  "ROLLER CHAIN COUPLING",
  "RUBBER IN COMPRESSION STYLE COUPLING - BLOCK",
  "RUBBER IN SHEAR COUPLING",
  "SINGLE BEAM COUPLING",
  "SLEEVE OR SPLIT-SLEEVE COUPLING",
  "SPLINE COUPLING",
  "TYRE COUPLING",
  "UNIVERSAL OR CARDAN SHAFT COUPLING",
  "V BELT"
];
const COUPLING_NEEDS_TEETH = new Set(["GEAR COUPLING","ROLLER CHAIN COUPLING","SPLINE COUPLING"]);
const COUPLING_NEEDS_BELTS = new Set(["BELT DRIVEN COUPLING","V BELT"]);


const ENV_OPTIONS = ["DUST-FLAMMABLE (DF)","DUST-NON FLAMMABLE (DNF)","GAS-FLAMMABLE (GF)","GAS-NON FLAMMABLE (GNF)","LIQUID FUMES-FLAMMABLE (LFF)","LIQUID FUMES-NON FLAMMABLE (LFNF)","HIGH TEMPERATURE(&amp;gt;75 DEG) (HT)","LOW TEMPERATURE(&amp;lt; 0 Deg) (LT)","MAGNETIC (M)"];
const OP_CYCLE = ["Single","Double","24x7","On Demand","Batch"];
const AGE = ["0-2","2-5","5-10","10-20",">20"];

const STEPS = [
  { id:1, key:"orgplant", name:"Org/Plant" },
  { id:2, key:"area", name:"Area" },
  { id:3, key:"equip", name:"Equip" },
  { id:4, key:"asset", name:"Asset" },
  { id:5, key:"ml", name:"ML" },
  { id:6, key:"coupling", name:"Coupling" },
  { id:7, key:"review", name:"Review" },
  { id:8, key:"send", name:"Send" }
];

const defaultState = () => ({
  step:0,
  orgplant:{ org:"", plant:"", industry:"", location:"", gps:{lat:"",lon:""}, spoc:{name:"",email:"",mobile:""}, network:"", atex:"None" },
  area:{ name:"", env:"" },
  equip:{ name:"", foundation:"", mounting:"", speedType:"", machineLoad:"", opCycle:"", age:"", assetsCount:1, photos:[], photo:"", typeOfApp:"", make:"", model:"", serial:"", singleLine:"", leadTime:"", downtimeCost:"", costRepairMajor:"", costRepairMinor:"" },
  assets:[ // at least Driver
    { role:"Driver", category:"", type:"", manufacturer:"", model:"", serial:"", kw:"", rpm:"", speedRatio:"1", mountCond:"", loadType:"", opCycle:"", orientation:"", rotorSupportType:"", vanesCount:"", photo:"", failureModes:["A1","B3","C4"], notes:"" }
  ],
  mls:[ // MLs referenced by asset index
  ],
  coupling:[ // pairings
    // { from:"Driver", to:"Driven 1", type:"", belts:"", ratio:"" }
  ],
  hierarchy: [],
  editRef: null,
  intent: null
});

let state = load();
render();

// Boot guard: if this version hasn't stamped, ensure we start on Home (step 0)
try {
  const verKey = LS_KEY + "_ver";
  if(!localStorage.getItem(verKey)){
    state.step = 0; save();
    localStorage.setItem(verKey, "1");
  }
} catch(e) {}


/** STORAGE **/
function load(){
  try{ const s = localStorage.getItem(LS_KEY); if(s) return JSON.parse(s); }catch(e){}
  return defaultState();
}
function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function reset(){ state = defaultState(); save(); render(); toast("Prototype reset"); }

/** RENDER **/
function render(){
  const footer = document.querySelector('.footer');
  if(state.step===0){ if(footer) footer.style.display='none'; $('#stepper').innerHTML=''; renderHome(); return; }
  if(footer) footer.style.display='';
  renderStepper();
  renderStep();
  syncCouplingsWithAssets();
  updateCTA();
}

function renderStepper(){
  const bar = $("#stepper"); bar.innerHTML="";
  STEPS.forEach(s => {
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.dataset.id = s.id;
    const status = stepStatus(s.id);
    if(s.id === state.step) chip.classList.add("active");
    else if(status === "done") chip.classList.add("done");
    chip.innerHTML = `<span class="icon">${status==="done"?"✓":s.id}</span><span>${s.name}</span>`;
    chip.onclick = () => { if(s.id <= maxReachableStep()){ state.step = s.id; save(); render(); } else { toast("Complete prior steps first"); } };
    bar.appendChild(chip);
  });
}

function stepStatus(stepId){
  if(stepId < state.step) return "done";
  if(stepId === state.step) return "active";
  return "todo";
}

function maxReachableStep(){ return state.step; }

function elCard(title, inner){
  return `<div class="card"><div class="sub" style="font-weight:600;color:${'var(--iu-sub)'};margin-bottom:8px">${title}</div>${inner}</div>`;
}

function inputField({id,label,placeholder="",type="text",value="",help="",attrs=""}){
  return `<div class="field">
    <label for="${id}">${label}</label>
    <input id="${id}" type="${type}" placeholder="${placeholder}" value="${escapeHtml(value)}" ${attrs}/>
    <div class="error" id="${id}_err"></div>
    ${help?`<div class="help">${help}</div>`:""}
  </div>`
}
function selectField({id,label,options=[],value="",placeholder="Select…"}){
  return `<div class="field">
    <label for="${id}">${label}</label>
    <select id="${id}">
      <option value="">${placeholder}</option>
      ${options.map(o=>`<option ${o===value?"selected":""} value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join("")}
    </select>
    <div class="error" id="${id}_err"></div>
  </div>`
}

function escapeHtml(str){ return String(str??"").replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }



function renderHome(){
  const s = state;
  const m = $("#main");
  const stepNames = ["Home","Org/Plant","Area","Equipment","Asset","ML","Coupling","Review","Send"];
  const niceStep = stepNames[Math.min(s.step||1, stepNames.length-1)];
  const org = s.org?.name || "—";
  const plant = s.plant?.name || "—";

  // Dummy drafts list (prototype-only)
  const drafts = [
    { id:"d1", title:"UltraTech — Crusher 1", time:"Today 09:45", step:3, org:"UltraTech", plant:"Crusher Plant" },
    { id:"d2", title:"MRF — Mixing Line 2", time:"Yesterday 14:12", step:2, org:"MRF", plant:"Mixing 2" }
  ];

  m.innerHTML = `
    <div class="card">
      <div class="title">Home</div>
      <div class="muted">Start a new survey or resume the current draft. Phone-first • Offline-friendly.</div>
      <div class="actions" style="margin-top:12px; gap:8px; flex-wrap:wrap">
        <button class="btn primary" id="btnNew">+ New Survey</button>
        <button class="btn" id="btnResume">Resume Draft</button>
      </div>
    </div>
    <div class="card" style="margin-top:12px">
      <div class="title">Current Draft</div>
      <div class="muted">Step: ${niceStep} • Org: ${org} • Plant: ${plant}</div>
    </div>
    <div class="card" style="margin-top:12px">
      <div class="title">Recent Drafts</div>
      ${drafts.map(d=>`
        <div class="row" style="align-items:center">
          <div style="flex:1">
            <div style="font-weight:600">${d.title}</div>
            <div class="muted">${d.time} • Step ${d.step}</div>
          </div>
          <button class="btn" data-draft="${d.id}">Open</button>
        </div>
      `).join('')}
    </div>
  `;

  // Actions
  const btnNew = $("#btnNew");
  if(btnNew){ btnNew.onclick = ()=>{ state = defaultState(); state.step=1; save(); render(); }; }

  const btnResume = $("#btnResume");
  if(btnResume){ btnResume.onclick = ()=>{ state.step = Math.max(state.step||1,1); save(); render(); }; }

  $$(".card [data-draft]").forEach(b=>{
    b.onclick = () => {
      const id = b.getAttribute('data-draft');
      const d = id==="d1" ? { step:3, org:"UltraTech", plant:"Crusher Plant" } : { step:2, org:"MRF", plant:"Mixing 2" };
      state = defaultState();
      state.org.name = d.org;
      state.plant.name = d.plant;
      state.step = d.step;
      save();
      render();
    };
  });
}

/** HIERARCHY HELPERS **/
function ensureHierarchySeed(){
  if(!state.hierarchy){ state.hierarchy = []; }
  if(state.hierarchy.length===0){
    const area = { name: state.area.name || "Area 1", env: state.area.env || "", equipments: [] };
    area.equipments.push(snapshotFromState());
    state.hierarchy.push(area);
    save();
  }
}
function snapshotFromState(){
  return {
    name: state.equip.name || "Equipment",
    sub: state.equip.typeOfApp || state.assets?.[0]?.category || "",
    snapshot: {
      area: clone(state.area),
      equip: clone(state.equip),
      assets: clone(state.assets),
      mls: clone(state.mls),
      coupling: clone(state.coupling)
    }
  };
}
function restoreFromSnapshot(snap){
  state.area = clone(snap.area||state.area);
  state.equip = clone(snap.equip||state.equip);
  state.assets = clone(snap.assets||state.assets);
  state.mls = clone(snap.mls||state.mls);
  state.coupling = clone(snap.coupling||state.coupling);
}
function saveEditRefIfAny(){
  if(state.editRef){
    const {areaIdx, equipIdx} = state.editRef;
    if(state.hierarchy?.[areaIdx]?.equipments?.[equipIdx]){
      state.hierarchy[areaIdx].equipments[equipIdx] = snapshotFromState();
    }
    state.editRef = null;
    save();
  }
}
function beginAddArea(){ 
  // start a brand-new area + equipment flow beginning at Step 2 (Area)
  state.intent = { kind:'add_area' };
  state.area = { name:'', env:'' };
  state.equip = clone(defaultState().equip);
  state.assets = clone(defaultState().assets);
  state.mls = [];
  state.coupling = [];
  state.step = 2; save(); render();
}
function beginAddEquipment(areaIdx){
  // start a brand-new equipment flow for an existing area beginning at Step 3 (Equipment)
  state.intent = { kind:'add_equipment', areaIdx };
  state.equip = clone(defaultState().equip);
  state.assets = clone(defaultState().assets);
  state.mls = [];
  state.coupling = [];
  state.step = 3; save(); render();
}
function copyEquipment(areaFrom, equipIdx, areaTo){
  const src = state.hierarchy?.[areaFrom]?.equipments?.[equipIdx];
  const dst = state.hierarchy?.[areaTo];
  if(!src || !dst) return;
  const item = clone(src);
  const base = (src.name || "Equipment").replace(/\s\(Copy(?: \d+)?\)$/i, "");
  // generate unique name in target area
  let n = 1, candidate = base + " (Copy)";
  const names = new Set(dst.equipments.map(e => e.name));
  while (names.has(candidate)) { n+=1; candidate = base + " (Copy " + n + ")"; }
  item.name = candidate;
  dst.equipments.push(item);
  save(); render();
}
function editEquipment(areaIdx, equipIdx){
  const rec = state.hierarchy?.[areaIdx]?.equipments?.[equipIdx];
  if(!rec) return;
  restoreFromSnapshot(rec.snapshot);
  state.intent = { kind:'edit_equipment', areaIdx, equipIdx };
  state.step = 3; save(); render();
}

function commitIntentOnReview(){
  const it = state.intent;
  if(!it) return;
  if(it.kind==='edit_equipment'){
    const { areaIdx, equipIdx } = it;
    if(state.hierarchy?.[areaIdx]?.equipments?.[equipIdx]){
      state.hierarchy[areaIdx].equipments[equipIdx] = snapshotFromState();
    }
    state.intent=null; save(); return;
  }
  if(it.kind==='add_equipment'){
    const { areaIdx } = it;
    if(state.hierarchy?.[areaIdx]){
      state.hierarchy[areaIdx].equipments.push(snapshotFromState());
    }
    state.intent=null; save(); return;
  }
  if(it.kind==='add_area'){
    const areaName = state.area?.name?.trim();
    const env = state.area?.env||'';
    if(areaName){
      state.hierarchy.push({ name: areaName, env, equipments: [ snapshotFromState() ] });
    }
    state.intent=null; save(); return;
  }
}
function renderStep(){
  const m = $("#main"); m.innerHTML="";
  const s = state;
  if(state.step===8){

    const issues = collectCrossStepIssues();
    const list = issues.map(it=>`<div class="issue"><div><b>${escapeHtml(it.title)}</b></div><div class="muted">${escapeHtml(it.detail)}</div><div class="actions" style="margin-top:6px"><button class="btn" onclick="jumpTo(${it.step})">Go to step ${it.step}</button></div></div>`).join("");
    m.innerHTML = elCard("Send for UAD",`
      <div class="list">
        <div class="pill">${issues.length? issues.length+" issue(s) found" : "All checks passed"}</div>
        ${list || '<div class="muted">No blocking issues. You can Send for UAD.</div>'}
        <div class="actions">
          <button class="btn" onclick="toast('Fix all navigates to first issue'); if(${issues.length}>0) jumpTo(${issues[0]?.step||1})">Fix All</button>
          <button class="btn primary" onclick="sendForUAD()" ${issues.some(i=>i.blocking)?'disabled':''}>Send for UAD</button>
        </div>
      </div>
    `);
    return;
  }

  if(state.step===1){
    m.innerHTML = elCard("Organization & Plant", `
      ${inputField({id:"org",label:"Organization",value:s.orgplant.org})}
      ${inputField({id:"plant",label:"Plant",value:s.orgplant.plant})}
      ${selectField({id:"industry",label:"Industry",options:["Automotive","Cement","Chemical","Energy","F&amp;B","Ferrous","Fertilizers","FMCG","Glass","Manufacturing","Mining &amp; Minerals","Non Ferrous","Oil and Gas","Pharma","Plastic","Port","Pulp and Paper","Textile","Tyre"],value:s.orgplant.industry})}
      ${inputField({id:"location",label:"Plant Location (free text)",value:s.orgplant.location})}
      <div class="row">
        ${inputField({id:"gps_lat",label:"GPS Lat (3dp)",value:s.orgplant.gps.lat, type:"text", help:"Optional"})}
        ${inputField({id:"gps_lon",label:"GPS Lon (3dp)",value:s.orgplant.gps.lon, type:"text"})}
      </div>
      ${inputField({id:"spoc_name",label:"SPOC Name",value:s.orgplant.spoc.name})}
      ${inputField({id:"spoc_email",label:"SPOC Email",value:s.orgplant.spoc.email})}
      ${inputField({id:"spoc_mobile",label:"SPOC Mobile",value:s.orgplant.spoc.mobile, type:"text", help:"Include country code if outside India"})}
      ${selectField({id:"network",label:"Best Mobile Network",options:["Airtel","Jio","Vodafone-Idea","Other"],value:s.orgplant.network})}
      ${selectField({id:"atex",label:"ATEX Zone",options:["None","Zone 1","Zone 2","Zone 21","Zone 22"],value:s.orgplant.atex})}
    `);
    bindInput("org", v=>s.orgplant.org=v);
    bindInput("plant", v=>s.orgplant.plant=v);
    bindSelect("industry", v=>s.orgplant.industry=v);
    bindInput("location", v=>s.orgplant.location=v);
    bindInput("gps_lat", v=>s.orgplant.gps.lat=v);
    bindInput("gps_lon", v=>s.orgplant.gps.lon=v);
    bindInput("spoc_name", v=>s.orgplant.spoc.name=v);
    bindInput("spoc_email", v=>s.orgplant.spoc.email=v);
    bindInput("spoc_mobile", v=>s.orgplant.spoc.mobile=v);
    bindSelect("network", v=>s.orgplant.network=v);
    bindSelect("atex", v=>s.orgplant.atex=v);
  }
  if(state.step===2){
    m.innerHTML = elCard("Area",`
      ${inputField({id:"area_name",label:"Area Name",value:s.area.name})}
      ${selectField({id:"area_env",label:"Environment",options:ENV_OPTIONS,value:s.area.env})}
    `);
    bindInput("area_name", v=>s.area.name=v);
    bindSelect("area_env", v=>s.area.env=v);
  }
  if(state.step===3){
    m.innerHTML = elCard("Equipment",`
      <div class="actions" style="justify-content:flex-end">
        <input type="file" accept="image/*" capture="environment" id="eq_photo_input" class="hidden">
        <button class="icon-btn" id="eq_photo_btn" aria-label="Add equipment photo"><svg viewBox="0 0 24 24" stroke-width="2"><path d="M3 8h4l2-3h6l2 3h4v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8z"/><circle cx="12" cy="14" r="4"/></svg></button>
      </div>
      ${s.equip.photo?`<div style="display:flex;justify-content:flex-end;margin-bottom:8px"><img src="${s.equip.photo}" alt="equip" style="width:72px;height:72px;object-fit:cover;border-radius:12px;border:1px solid var(--iu-border)"/></div>`:""}
      ${inputField({id:"eq_name",label:"Equipment Name",value:s.equip.name})}
      ${selectField({id:"eq_found",label:"Foundation Type",options:["Rigid","Flexible"],value:s.equip.foundation})}
      ${selectField({id:"eq_mount",label:"Mounting Orientation",options:["Horizontal","Vertical","Inclined"],value:s.equip.mounting})}
      ${selectField({id:"eq_speed",label:"Speed Type",options:["Fixed","VFD"],value:s.equip.speedType})}
      ${selectField({id:"eq_load",label:"Machine Load",options:["Fixed","Variable"],value:s.equip.machineLoad})}
      ${selectField({id:"eq_cycle",label:"Operation Cycle",options:OP_CYCLE,value:s.equip.opCycle})}
      ${selectField({id:"eq_app",label:"Type of Application",options:[
        "Baghouse Fan","Belt Conveyor","Booster Fan","Bucket Elevator","Cement Mill","Classifier Drive","Clinkers","Coal Mill","FD Fan",
        "Hammer Crusher","ID Fan","Kiln Main Drive","Main Drive","Packing Plant","Pre Grinder","Preheater Fan","Raw Mill Fans","Roll Press",
        "Roller Press","Rolling Mill","Separator","Sepax Fan","Suction Fan","Twin Drive","VRM"
      ],value:s.equip.typeOfApp})}
      ${inputField({id:"eq_make",label:"Make/Manufacturer",value:s.equip.make})}
      ${inputField({id:"eq_model",label:"Model",value:s.equip.model})}
      ${inputField({id:"eq_serial",label:"Serial Number",value:s.equip.serial})}
      ${selectField({id:"eq_singleline",label:"Is this a single-line equipment?",options:["Yes","No"],value:s.equip.singleLine})}
      ${selectField({id:"eq_leadtime",label:"Lead time to procure spares",options:["1 week","1 month","1 Quarter","6 months and more"],value:s.equip.leadTime})}
      ${inputField({id:"eq_downtime",label:"Per hour Downtime cost ($)",type:"number",value:s.equip.downtimeCost})}
      ${inputField({id:"eq_cost_major",label:"Cost of Repair : Major Breakdown",type:"number",value:s.equip.costRepairMajor,help:"Major breakdown includes Bearing Failure, Gear Failure, Shaft Failure."})}
      ${inputField({id:"eq_cost_minor",label:"Cost of Repair : Minor Breakdown",type:"number",value:s.equip.costRepairMinor,help:"Minor breakdown includes coupling failure, early stage faults (unbalance, misalignment, etc.)."})}

      ${selectField({id:"eq_age",label:"Age",options:AGE,value:s.equip.age})}
      ${assetsCountControl()}
    `);
    bindInput("eq_name", v=>s.equip.name=v);
    const eqpb=$("#eq_photo_btn"), eqpi=$("#eq_photo_input");
    if(eqpb && eqpi){ eqpb.onclick=()=>eqpi.click(); eqpi.onchange=(e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ s.equip.photo=ev.target.result; save(); render(); }; r.readAsDataURL(f); }; }
    bindSelect("eq_found", v=>s.equip.foundation=v);
    bindSelect("eq_mount", v=>s.equip.mounting=v);
    bindSelect("eq_speed", v=>s.equip.speedType=v);
    bindSelect("eq_load", v=>s.equip.machineLoad=v);
    bindSelect("eq_cycle", v=>s.equip.opCycle=v);
    bindSelect("eq_age", v=>s.equip.age=v);
    bindSelect("eq_app", v=>s.equip.typeOfApp=v);
    bindInput("eq_make", v=>s.equip.make=v);
    bindInput("eq_model", v=>s.equip.model=v);
    bindInput("eq_serial", v=>s.equip.serial=v);
    bindSelect("eq_singleline", v=>s.equip.singleLine=v);
    bindSelect("eq_leadtime", v=>s.equip.leadTime=v);
    bindInput("eq_downtime", v=>s.equip.downtimeCost=v);
    bindInput("eq_cost_major", v=>s.equip.costRepairMajor=v);
    bindInput("eq_cost_minor", v=>s.equip.costRepairMinor=v);

    ["assets_1","assets_2","assets_3","assets_4"].forEach((id,ix)=>{ const b=$("#"+id); if(b) b.onclick=()=>adjustAssetsCount(ix+1); });
    const ob=$("#assets_other"); if(ob) ob.onclick=()=>{ adjustAssetsCount(Math.max(5, Number(state.equip.assetsCount)||5)); };
    const of=$("#eq_assets_other"); if(of) of.addEventListener("input", e=>adjustAssetsCount(e.target.value));
    s.assets.forEach((a,i)=>{ if(i===0)a.role="Driver"; else a.role="Driven "+i; });
  }
  if(state.step===4){
    const assetTabs = s.assets.map((a,i)=>`<button class="btn ${i===currentAssetIndex?'primary':''}" data-asset="${i}">${a.role}</button>`).join(" ");
    const a = s.assets[currentAssetIndex];
    const catOpts = ["Agitator","Alternator","Blower","Compressor","Conveyor","Crusher","Dryer","Engine","Extruder","Fan","Gearbox","Generator","Mill","Mixer","Motor","Others","Pinion","Pump","Roll","Roller","Rope","Spindle","Turbine","VibroScreen"];
    const typeOptsByCat = {"Agitator":["Agitator"],"Alternator":["Alternator"],"Blower":["Blower","Roots Blower","Screw Blower"],"Compressor":["Centrifugal Compressor","Reciprocating Compressor","Screw Compressor"],"Conveyor":["Belt Conveyor","Bucket Elevator","Chain Conveyor","Pan Conveyor"],"Crusher":["Cone Crusher","Hammer Crusher","Jaw Crusher"],"Dryer":["Cylinder"],"Engine":["2 Stroke IC Engine","4 Stroke IC Engine","5 Stroke IC Engine"],"Extruder":["Extruder"],"Fan":["Axial Fan","Centrifugal Fan (Double-Inlet)","Centrifugal Fan (Single-Inlet)","Overhung Fan"],"Gearbox":["Bevel Gearbox","Helical Gearbox","Planetary Gearbox","Worm Gearbox"],"Generator":["Diesel Generator Set","Steam Turbine Generator"],"Mill":["Ball Mill","Pinion","Roller Press","Vertical Roller Mill"],"Mixer":["Mixer"],"Motor":["AC Motor","DC Motor","Hydraulic Motor","Servo Motor"],"Others":["Non-standard"],"Pinion":["Pinion"],"Pump":["Centrifugal Pump (Multistage)","Centrifugal Pump (Overhung)","Centrifugal Pump (Between Bearings)","Gear Pump","Monoblock","Piston Pump","Reciprocating Pump","Screw Pump"],"Roll":["Granulator"],"Roller":["Calender Roll"],"Rope":["Drum"],"Spindle":["Spindle"],"Turbine":["Gas Turbine","Steam Turbine","Wind Turbine"],"VibroScreen":["Vibro Screen"]};
    const typeOpts = typeOptsByCat[a.category||"Motor"];
    m.innerHTML = elCard("Assets",`
      <div class="actions">${assetTabs}</div>
      <div style="height:8px"></div>
      <div class="actions" style="justify-content:flex-end">
        <input type="file" accept="image/*" capture="environment" id="a_photo_input" class="hidden">
        <button class="icon-btn" id="a_photo_btn" aria-label="Add asset photo"><svg viewBox="0 0 24 24" stroke-width="2"><path d="M3 8h4l2-3h6l2 3h4v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8z"/><circle cx="12" cy="14" r="4"/></svg></button>
      </div>

      ${a.photo?`<div style="display:flex;justify-content:flex-end;margin-bottom:8px"><img src="${a.photo}" alt="photo" style="width:72px;height:72px;object-fit:cover;border-radius:12px;border:1px solid var(--iu-border)"/></div>`:""}
      ${selectField({id:"a_cat",label:"Category",options:catOpts,value:a.category})}
      ${selectField({id:"a_type",label:"Type",options:typeOpts,value:a.type})}
      ${inputField({id:"a_manu",label:"Manufacturer",value:a.manufacturer})}
      ${inputField({id:"a_model",label:"Model",value:a.model})}
      ${inputField({id:"a_serial",label:"Serial Number",value:a.serial})}
      <div class="row">
        ${inputField({id:"a_kw",label:"kW",type:"number",value:a.kw})}
        ${inputField({id:"a_rpm",label:"RPM <span class=\"req\">*</span>",type:"number",value:a.rpm, help:"Warning if AC motor exactly 3000"})}
      </div>
      <div class="row">
        ${inputField({id:"a_ratio",label:"Speed Ratio",type:"text",value:a.speedRatio})}
        </div>
      ${selectField({id:"a_mount",label:"Mounting Condition",options:["At Ground","On Rigid Concrete","Above Ground Level","On Vibro Pad","On Steel Structure"],value:a.mountCond})}
      <div class="row">
        ${selectField({id:"a_load",label:"Load Type",options:["Fixed","Variable"],value:a.loadType})}
        ${selectField({id:"a_cycle",label:"Operation Cycle",options:OP_CYCLE,value:a.opCycle})}
      </div>
      ${selectField({id:"a_orient",label:"Orientation",options:["Horizontal","Vertical","Incline"],value:a.orientation})}
      ${selectField({id:"a_rotor",label:"Rotor Support Type",options:["Over Hung","Center Hung"],value:a.rotorSupportType})}
      ${inputField({id:"a_vanes",label:"Number of Vanes/Impeller/Lobes",type:"number",value:a.vanesCount})}
      <div class="field">
        <label>Failure Modes (auto)</label>
        <div class="help">Default: ${a.failureModes.join(", ")}</div>
      </div>
      ${textareaField("a_notes","Notes",a.notes)}
    `);
    $$(".actions .btn").forEach(b=>b.onclick = ()=>{ currentAssetIndex = parseInt(b.dataset.asset,10); render(); });
    bindSelect("a_cat", v=>{ a.category=v; a.type=""; render(); });
    bindSelect("a_type", v=>a.type=v);
    bindInput("a_manu", v=>a.manufacturer=v);
    bindInput("a_model", v=>a.model=v);
    bindInput("a_serial", v=>a.serial=v);
    bindInput("a_kw", v=>a.kw=v);
    bindInput("a_rpm", v=>a.rpm=v);
    bindInput("a_ratio", v=>a.speedRatio=v);
        bindSelect("a_mount", v=>a.mountCond=v);
    bindSelect("a_load", v=>a.loadType=v);
    bindSelect("a_cycle", v=>a.opCycle=v);
    bindSelect("a_orient", v=>a.orientation=v);
    bindTextarea("a_notes", v=>a.notes=v);
    const photoBtn = $("#a_photo_btn"); const photoInput = $("#a_photo_input");
    if(photoBtn && photoInput){
      photoBtn.onclick = ()=>photoInput.click();
      photoInput.onchange = (e)=>{
        const file = e.target.files && e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = ev => { a.photo = ev.target.result; save(); render(); };
        reader.readAsDataURL(file);
      };
    }
    bindSelect("a_rotor", v=>a.rotorSupportType=v);
    bindInput("a_vanes", v=>a.vanesCount=v);
    if((a.type==="AC Motor") && String(a.rpm)==="3000"){
      const e = $("#a_rpm_err"); e.classList.remove("error"); e.classList.add("warn"); e.textContent = "AC motors typically ~2960 RPM at 50Hz. Recheck nameplate.";
    }
  }
  if(state.step===5){
    const assetChips = s.assets.map((a,i)=>`<button class="btn ${i===mlAssetIndex?'primary':''}" data-idx="${i}">${a.role}</button>`).join(" ");
    const mlList = s.mls.filter(x=>x.asset===mlAssetIndex);
    m.innerHTML = elCard("Measurement Locations",`
      <div class="actions">${assetChips}</div>
      <div class="actions">
        <button class="btn" id="btnAddML">+ Add ML</button>
        <button class="btn" id="btnSuggestML">Auto-suggest MLs</button>
      </div>
      <div id="mlContainer"></div>
    `);
    $$(".actions .btn").forEach(b=>{ if(b.dataset.idx!==undefined){ b.onclick=()=>{ mlAssetIndex=parseInt(b.dataset.idx,10); render(); }; } });
    $("#btnAddML").onclick = ()=>{ addML(mlAssetIndex); render(); };
    $("#btnSuggestML").onclick = ()=>{ suggestMLs(mlAssetIndex); render(); };
    const cont = $("#mlContainer");
    cont.innerHTML = mlList.length? "" : `<div class="muted">No MLs yet.</div>`;
    mlList.forEach((ml,ix)=>{
      cont.innerHTML += elCard(`${state.assets[mlAssetIndex].role} — ML ${ix+1}`, `
        <div class="actions" style="justify-content:space-between">
          <button class="btn danger" id="ml_${ix}_del">Delete ML</button>
          <div>
            <input type="file" accept="image/*" capture="environment" id="ml_${ix}_photo_input" class="hidden">
            <button class="icon-btn" id="ml_${ix}_photo_btn" aria-label="Add ML photo"><svg viewBox="0 0 24 24" stroke-width="2"><path d="M3 8h4l2-3h6l2 3h4v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8z"/><circle cx="12" cy="14" r="4"/></svg></button>
          </div>
        </div>
        ${state.mls.indexOf(ml)>-1 && state.mls[state.mls.indexOf(ml)].photo?`<div style="display:flex;justify-content:flex-end;margin-bottom:8px"><img src="${state.mls[state.mls.indexOf(ml)].photo}" alt="ml" style="width:72px;height:72px;object-fit:cover;border-radius:12px;border:1px solid var(--iu-border)"/></div>`:""}
        ${inputField({id:`ml_${ix}_name`,label:"ML Name",value:ml.name})}
        ${selectField({id:`ml_${ix}_pos`,label:"Monitoring Position",options:["Drive End","Non-Drive End"],value:ml.position})}
        ${selectField({id:`ml_${ix}_orient`,label:"Orientation <span class=\"req\">*</span>",options:[
          "X-Axial, Y-Horizontal, Z-Vertical",
          "X-Axial, Y-Vertical, Z-Horizontal",
          "X-Horizontal, Y-Axial, Z-Vertical",
          "X-Horizontal, Y-Vertical, Z-Axial",
          "X-Vertical, Y-Axial, Z-Horizontal",
          "X-Vertical, Y-Horizontal, Z-Axial"
        ],value:ml.orient})}
        ${selectField({id:`ml_${ix}_clock`,label:"Sensor Mounting Position <span class=\"req\">*</span>",options:["1","2","3","4","5","6","7","8","9","10","11","12"],value:ml.clock})}
        ${selectField({id:`ml_${ix}_sensor`,label:"Sensor Model",options:Object.keys(SENSOR_RPM_BANDS),value:ml.sensor})}
        ${selectField({id:`ml_${ix}_speedtype`,label:"Speed Type",options:["Fixed","Variable"],value:ml.speedType||"Fixed"})}
        <div class="row">
          ${inputField({id:`ml_${ix}_rpm`,label:"RPM <span class=\"req\">*</span>",type:"number",value:ml.rpm})}
        </div>
      `);
      // Bindings (use object identity to get the correct global index on delete/photo)
      bindInput(`ml_${ix}_name`, v=>ml.name=v);
      bindSelect(`ml_${ix}_pos`, v=>ml.position=v);
      bindSelect(`ml_${ix}_orient`, v=>ml.orient=v);
      bindSelect(`ml_${ix}_clock`, v=>ml.clock=v);
      bindSelect(`ml_${ix}_sensor`, v=>ml.sensor=v);
      bindSelect(`ml_${ix}_speedtype`, v=>ml.speedType=v);
      bindInput(`ml_${ix}_rpm`, v=>ml.rpm=v);

      const delBtn = document.querySelector(`#ml_${ix}_del`);
      if(delBtn){ delBtn.onclick = ()=>{ 
        const gi = state.mls.indexOf(ml);
        if(gi>-1){ state.mls.splice(gi,1); save(); render(); }
      };}

      const pb = document.querySelector(`#ml_${ix}_photo_btn`), pi = document.querySelector(`#ml_${ix}_photo_input`);
      if(pb && pi){ pb.onclick=()=>pi.click(); pi.onchange=(e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ 
        const gi = state.mls.indexOf(ml);
        if(gi>-1){ state.mls[gi].photo=ev.target.result; save(); render(); }
      }; r.readAsDataURL(f); }; }
    });
  }
  
  if(state.step===6){
    syncCouplingsWithAssets();
    const roles = state.assets.map(a=>a.role);
    const pairs = state.coupling;
    const note = roles.length>=2 ? '<div class="help">Pairs are auto-created between adjacent assets (Driver ⇄ Driven).</div>' : '<div class="muted">Add at least two assets to define couplings.</div>';
    m.innerHTML = elCard("Coupling",`
      ${note}
      <div id="pairs"></div>
    `);
    const p = $("#pairs");
    if(!pairs.length){ p.innerHTML = '<div class="muted">No pairs available.</div>'; }
    pairs.forEach((c,ix)=>{
      const left = roles[c.between?c.between[0]:ix];
      const right = roles[c.between?c.between[1]:(ix+1)];
      const showBelts = COUPLING_NEEDS_BELTS.has(c.type);
      const showTeeth = COUPLING_NEEDS_TEETH.has(c.type);
      p.innerHTML += elCard(`Between ${left} ⇄ ${right}`,`
        <div class="actions" style="justify-content:flex-end">
          <input type="file" accept="image/*" capture="environment" id="cp_${ix}_photo_input" class="hidden">
          <button class="icon-btn" id="cp_${ix}_photo_btn" aria-label="Add coupling photo"><svg viewBox="0 0 24 24" stroke-width="2"><path d="M3 8h4l2-3h6l2 3h4v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8z"/><circle cx="12" cy="14" r="4"/></svg></button>
        </div>
        ${state.coupling[ix].photo?`<div style="display:flex;justify-content:flex-end;margin-bottom:8px"><img src="${state.coupling[ix].photo}" alt="pair" style="width:72px;height:72px;object-fit:cover;border-radius:12px;border:1px solid var(--iu-border)"/></div>`:""}

        ${selectField({id:`cp_${ix}_type`,label:"Coupling Type",options:COUPLING_TYPES,value:c.type})}
        <div class="row">
          ${showBelts? inputField({id:`cp_${ix}_belts`,label:"Number of Belts",type:"number",value:c.belts||""}) : ''}
          ${showTeeth? inputField({id:`cp_${ix}_ratio`,label:"Number of Teeth/Ratio",type:"text",value:c.ratio||""}) : ''}
        </div>
      `);
      bindSelect(`cp_${ix}_type`, v=>{ c.type=v; save(); render(); });
      const beltsEl = document.querySelector(`#cp_${ix}_belts`);
      if(beltsEl) beltsEl.addEventListener("input", e=>{ c.belts=e.target.value; save(); updateCTA(); });
      const ratioEl = document.querySelector(`#cp_${ix}_ratio`);
      if(ratioEl) ratioEl.addEventListener("input", e=>{ c.ratio=e.target.value; save(); updateCTA(); });
      const cpb = document.querySelector(`#cp_${ix}_photo_btn`), cpi = document.querySelector(`#cp_${ix}_photo_input`);
      if(cpb && cpi){ cpb.onclick=()=>cpi.click(); cpi.onchange=(e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ c.photo=ev.target.result; save(); render(); }; r.readAsDataURL(f); }; }
    });
  }

if(state.step===7){
    // Save any edit-in-progress into records; seed hierarchy if empty
    ensureHierarchySeed();
    saveEditRefIfAny();
    commitIntentOnReview();

    const H = state.hierarchy;
    // Header card
    let htmlDash = `<div class="card shadow-none" style="background:linear-gradient(90deg,var(--iu-grad-start),var(--iu-grad-end));color:#fff">
      <div style="font-size:18px;font-weight:700">Site Survey Dashboard</div>
      <div class="muted" style="color:#e9ecff">Infinite Uptime</div>
    </div>`;

    H.forEach((area, ai)=>{
      htmlDash += `<div class="card">
        <div class="row" style="align-items:center;justify-content:space-between">
          <div>
            <div style="font-weight:700">${escapeHtml(area.name)}</div>
            <div class="muted">${area.equipments.length} Equipment Registered</div>
          </div>
          <div class="actions">
            <button class="btn" id="area_${ai}_add">+ Add Equipment</button>
          </div>
        </div>
        <div class="muted" style="margin-top:8px">Equipment in ${escapeHtml(area.name)}</div>
        <div id="area_${ai}_list"></div>
      </div>`;
    });

    m.innerHTML = htmlDash + `<div style="position:fixed;right:20px;bottom:90px"><button class="btn primary" id="btnAddArea">+ Area</button></div>`;

    // Populate lists & bind actions
    state.hierarchy.forEach((area, ai)=>{
      const list = document.getElementById(`area_${ai}_list`);
      list.innerHTML = area.equipments.map((eq,ix)=>`
        <div class="card" style="margin:8px 0;padding:12px">
          <div class="row" style="align-items:center;justify-content:space-between">
            <div>
              <div style="font-weight:600">${escapeHtml(eq.name)}</div>
              <div class="muted">${escapeHtml(eq.sub||"")}</div>
            </div>
            <div class="actions">
              <button class="btn" id="cpy_${ai}_${ix}">Copy</button>
              <button class="btn" id="edt_${ai}_${ix}">Edit</button>
            </div>
          </div>
          <div id="cpy_${ai}_${ix}_picker" class="hidden" style="margin-top:8px">
            <label class="help">Copy to area</label>
            <select id="cpy_${ai}_${ix}_sel">
              ${state.hierarchy.map((a,j)=>`<option value="${j}" ${j===ai?'selected':''}>${escapeHtml(a.name)}</option>`).join('')}
            </select>
            <div class="actions" style="margin-top:8px">
              <button class="btn" id="cpy_${ai}_${ix}_do">Copy here</button>
              <button class="btn" id="cpy_${ai}_${ix}_cancel">Cancel</button>
            </div>
          </div>
        </div>`).join("");
      const addBtn = document.getElementById(`area_${ai}_add`);
      if(addBtn) addBtn.onclick = ()=> beginAddEquipment(ai);

      // per-equip bindings
      area.equipments.forEach((eq,ix)=>{
        const c = document.getElementById(`cpy_${ai}_${ix}`);
        const p = document.getElementById(`cpy_${ai}_${ix}_picker`);
        const s = document.getElementById(`cpy_${ai}_${ix}_sel`);
        const d = document.getElementById(`cpy_${ai}_${ix}_do`);
        const x = document.getElementById(`cpy_${ai}_${ix}_cancel`);
        if(c) c.onclick = ()=>{ s.value = String(ai); p.classList.remove('hidden'); };
        if(x) x.onclick = ()=>{ p.classList.add('hidden'); };
        if(d) d.onclick = ()=>{ const tv = parseInt(s.value,10); const tgt = Number.isInteger(tv) ? tv : ai; copyEquipment(ai, ix, tgt); };
        const ebtn = document.getElementById(`edt_${ai}_${ix}`);
        if(ebtn) ebtn.onclick = ()=> editEquipment(ai, ix);
      });
    });

    const addAreaBtn = document.getElementById('btnAddArea');
    if(addAreaBtn) addAreaBtn.onclick = beginAddArea;
  }

  }






function updateCTA(){
  const cta = $("#btnNext");
  const info = $("#ctaInfo");
  let errors = validateCurrentStep();
  if(errors.length){
    cta.classList.add("disabled");
    info.textContent = `Fix ${errors.length} field${errors.length>1?'s':''} to continue`;
    show(info);
  } else {
    cta.classList.remove("disabled");
    hide(info);
  }
  cta.onclick = ()=>{
    const errs = validateCurrentStep(true);
    if(errs.length){ toast("Please fix highlighted fields"); return; }
    if(state.step < 8){ state.step += 1; save(); render(); }
  };
}

/** FIELD BINDING **/
function bindInput(id, on){
  const el = $("#"+id); el.addEventListener("input", e=>{ on(e.target.value); save(); updateCTA(); });
  el.addEventListener("blur", ()=>{ validateCurrentStep(); updateCTA(); });
}
function bindSelect(id, on){
  const el = $("#"+id); el.addEventListener("change", e=>{ on(e.target.value); save(); validateCurrentStep(); updateCTA(); });
}
function bindTextarea(id, on){
  const el = $("#"+id); el.addEventListener("input", e=>{ on(e.target.value); save(); updateCTA(); });
}
function textareaField(id,label,value=""){ return `<div class="field"><label for="${id}">${label}</label><textarea id="${id}">${escapeHtml(value)}</textarea><div class="error" id="${id}_err"></div></div>`; }
function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }


function syncCouplingsWithAssets(){
  const roles = state.assets.map(a=>a.role);
  const expected = [];
  for(let i=0;i<roles.length-1;i++){
    const leftRole = roles[i], rightRole = roles[i+1];
    let existing = state.coupling.find(p => (p.between && p.between[0]===i && p.between[1]===i+1) || (p.from===leftRole && p.to===rightRole));
    expected.push(existing ? existing : { between:[i,i+1], type:"", belts:"", ratio:"", photo:"" });
  }
  state.coupling = expected;
  save();
}
function assetsCountControl(){
  const n = Number(state.equip.assetsCount||1);
  const isOther = !(n>=1 && n<=4);
  const otherVal = isOther ? n : 5;
  return `<div class="field">
    <label>No. Of Assets</label>
    <div class="actions">
      ${[1,2,3,4].map(i=>`<button type="button" class="btn ${n===i?'primary':''}" id="assets_${i}">${i}</button>`).join(" ")}
      <button type="button" class="btn ${isOther?'primary':''}" id="assets_other">Other</button>
    </div>
    <div id="assets_other_field" class="${isOther?'':'hidden'}" style="margin-top:8px">
      <input id="eq_assets_other" type="number" min="1" max="12" value="${otherVal}" />
      <div class="help">Enter a count ≥ 1. We recommend keeping this under 12 for mobile usability.</div>
    </div>
  </div>`;
}
function adjustAssetsCount(n){
  n = Math.max(1, Math.min(12, Number(n)||1));
  state.equip.assetsCount = n;
  while(state.assets.length < n){
    const t = clone(defaultState().assets[0]);
    t.role = "Driven " + state.assets.length;
    state.assets.push(t);
  }
  while(state.assets.length > n){
    state.assets.pop();
  }
  // Drop MLs that point to non-existent assets
  state.mls = state.mls.filter(ml => ml.asset < n);
  // Auto-sync coupling pairs between adjacent assets
  syncCouplingsWithAssets();
  // Clamp indices
  if(currentAssetIndex >= n) currentAssetIndex = Math.max(0, n-1);
  if(mlAssetIndex >= n) mlAssetIndex = Math.max(0, n-1);
  save();
  render();
  updateCTA();
}


/** STEP VALIDATIONS (scoped) **/
let currentAssetIndex = 0;
let mlAssetIndex = 0;

function validateCurrentStep(showErrors=false){
  $$(".error").forEach(e=>e.textContent="");
  $$(".error").forEach(e=>{ e.classList.remove("warn"); e.classList.add("error"); });
  const errs = [];
  const pushErr = (id,msg)=>{ errs.push({id,msg}); if(showErrors){ const el=$("#"+id+"_err"); if(el){ el.textContent=msg; document.getElementById(id)?.scrollIntoView({block:"nearest"});} } };
  const s = state;
  switch(state.step){
    case 1:{
      if(!s.orgplant.org.trim()) pushErr("org","Organization is required");
      if(!s.orgplant.plant.trim()) pushErr("plant","Plant is required");
      if(!s.orgplant.industry) pushErr("industry","Industry is required");
      if(s.orgplant.spoc.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s.orgplant.spoc.email)) pushErr("spoc_email","Invalid email format");
      if(s.orgplant.spoc.mobile && !/^[0-9+\-\s()]{7,20}$/.test(s.orgplant.spoc.mobile)) pushErr("spoc_mobile","Invalid phone format");
      const lat=s.orgplant.gps.lat, lon=s.orgplant.gps.lon;
      if(lat && !/^-?\d{1,3}\.\d{1,6}$/.test(lat)) pushErr("gps_lat","Use decimal (up to 6 dp)");
      if(lon && !/^-?\d{1,3}\.\d{1,6}$/.test(lon)) pushErr("gps_lon","Use decimal (up to 6 dp)");
      break;
    }
    case 2:{
      if(!s.area.name.trim()) pushErr("area_name","Area name is required");
      if(!s.area.env) pushErr("area_env","Environment is required");
      break;
    }
    case 3:{
      if(!s.equip.name.trim()) pushErr("eq_name","Equipment name is required");
      if(!s.equip.speedType) pushErr("eq_speed","Speed type is required");
      if(!s.equip.machineLoad) pushErr("eq_load","Machine load is required");
      if(!s.equip.opCycle) pushErr("eq_cycle","Operation cycle is required");
      break;
    }
    case 4:{
      const a = s.assets[currentAssetIndex];
      if(!a.category) pushErr("a_cat","Category is required");
      if(!a.type) pushErr("a_type","Type is required");
      const isRotating = ["Motor","Gearbox","Fan","Compressor","Pump","Mill","Generator","Mixer","Blower","Extruder","Agitator","Conveyor","Crusher","Dryer","Engine","Pinion","Roll","Roller","Rope","Spindle","Turbine","VibroScreen"].includes(a.category||"");
      if(isRotating && !String(a.rpm).trim()) pushErr("a_rpm","RPM is required for rotating assets");
      if(a.type==="AC Motor" && String(a.rpm)==="3000"){
        const el=$("#a_rpm_err"); el.textContent="AC motors typically ~2960 RPM at 50Hz. Recheck nameplate."; el.classList.remove("error"); el.classList.add("warn");
      }
      break;
    }
    case 5:{
      const list = s.mls.filter(x=>x.asset===mlAssetIndex);
      if(!list.length){ errs.push({id:null,msg:"Add at least one ML"}); if(showErrors) toast("Add at least one ML"); break; }
      list.forEach((ml,ix)=>{
        const base=`ml_${ix}`;
        if(!ml.name) pushErr(`${base}_name`,"ML name required");
        if(!ml.position) pushErr(`${base}_pos`,"Monitoring Position required");
        if(!ml.orient) pushErr(`${base}_orient`,"Orientation required");
        if(!ml.clock) pushErr(`${base}_clock`,"Sensor Mounting Position required");
        if(!ml.sensor) pushErr(`${base}_sensor`,"Sensor model required");
                                const rpm = Number(ml.rpm);
        if(!ml.rpm || isNaN(rpm)) pushErr(`${base}_rpm`,"RPM required");
        else{
          const band = SENSOR_RPM_BANDS[ml.sensor]; 
          if(band && (rpm<band[0] || rpm>band[1])) pushErr(`${base}_rpm`, `RPM invalid for ${ml.sensor}. Allowed ${band[0]}–${band[1]}.`);
        }
      });
      break;
    }
    
    case 6:{
      const roles = state.assets.map(a=>a.role);
      syncCouplingsWithAssets();
      const pairs = state.coupling;
      if(roles.length>=2 && !pairs.length){ errs.push({id:null,msg:"Add at least two assets to define couplings"}); break; }
      pairs.forEach((c,ix)=>{
        if(!c.type) errs.push({id:null,msg:`Pair ${ix+1}: Coupling Type required`});
        if(c.type && COUPLING_NEEDS_BELTS.has(c.type) && !String(c.belts||'').trim()) errs.push({id:null,msg:`Pair ${ix+1}: Number of Belts required`});
        if(c.type && COUPLING_NEEDS_TEETH.has(c.type) && !String(c.ratio||'').trim()) errs.push({id:null,msg:`Pair ${ix+1}: Number of Teeth/Ratio required`});
      });
      break;
    }

    case 7: default: break;
  }
  return errs;
}

/** CROSS-STEP VALIDATIONS (Review) **/
function collectCrossStepIssues(){
  const issues=[];
  const s=state;
  if(s.coupling.length>1){
    const allOne = s.coupling.every(c => Number(c.ratio||"1")==1);
    if(allOne) issues.push({step:6, blocking:true, title:"Gearbox stage speeds identical", detail:"For multi-stage trains, stage speeds must differ; set ratios for each stage."});
  }
  if(s.equip.speedType==="Fixed"){
    const anyVarML = s.mls.some(ml => (ml.speedType==="Variable"));
    if(anyVarML) issues.push({step:5, blocking:true, title:"Speed inconsistency", detail:"Equipment marked Fixed-speed but one or more MLs set to Variable."});
  }
  state.assets.forEach((a,i)=>{
    if(a.type==="AC Motor" && String(a.rpm)==="3000"){
      issues.push({step:4, blocking:false, title:`Asset ${a.role}: AC motor at exactly 3000 RPM`, detail:"Typical synchronous speeds are ~2960 RPM at 50 Hz. Recheck nameplate."});
    }
  });
  return issues;
}

function bindError(id, msg){ const el=$("#"+id+"_err"); if(el) el.textContent=msg||""; }
function addML(assetIdx){
  state.mls.push({ asset:assetIdx, name:"", position:"", orient:"", clock:"", sensor:"", rpm:"", photo:"", speedType:"Fixed" });
  save();
}
function suggestMLs(assetIdx){
  const a = state.assets[assetIdx];
  const want = (a?.category==="Motor"||a?.category==="Gearbox") ? 2 : 1;
  let existing = state.mls.filter(x=>x.asset===assetIdx).length;
  for(let i=existing;i<want;i++){ addML(assetIdx); }
  toast(`Added ${want-existing} ML${want-existing>1?'s':''}`);
}
function addPair(){
  const roles = state.assets.map(a=>a.role);
  state.coupling.push({from:roles[0]||"Driver", to:roles[1]||"Driven 1", type:"", belts:"", ratio:"", photo:""});
  save();
}
function jumpTo(step){ state.step=step; save(); render(); }

function sendForUAD(){
  toast("Survey queued for UAD (simulated)");
}

$("#btnExport").onclick = ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "sdd_survey_export.json"; a.click();
  URL.revokeObjectURL(url);
};
$("#btnReset").onclick = reset;
$("#btnHome").onclick = ()=>{ state.step=0; save(); render(); };

</script>
</body>
</html>
